<!DOCTYPE html>
<html layout:decorate="~{admin/layout}"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<div layout:fragment="content" class="container">
	<h5 class="my-3 border-bottom pb-2">게시판</h5>
	<form method="post" th:object="${boardForm}">
		<input type="hidden" th:name="${_csrf.parameterName}"
			th:value="${_csrf.token}" id="_csrf" />
		<div th:replace="~{form_errors :: formErrorsFragment}"></div>

		<div class="mb-3">
			<label for="subject" class="form-label">제목</label><input type="text"
				th:field="*{subject}" class="form-control">
		</div>
		<div class="mb-3">
			<label for="content" class="form-label">내용</label>
			<div id="content" class="form-control"></div>
			<input type="hidden" name="content" id="ecp"><input
				type="hidden" id="ecp1" th:field="*{content}">
		</div>
		<input type="submit" value="저장" class="btn btn-info my-2"> <a
			class="btn btn-outline-info" th:href="@{/admin/board/list}">취소</a>
	</form>
</div>
<script layout:fragment="script" type="text/javascript"
	th:inline="javascript">

	var files;
		const editor = new toastui.Editor({
			el : document.querySelector('#content'),
			height : '500px', 
			initialEditType : 'markdown', 
			initialValue : '',
			previewStyle : 'vertical',
			placeholder : '내용을 입력해 주세요.',
			  hooks: {
				   async addImageBlobHook(blob, callback) { 
					   try {
		                    const formData = new FormData();
		                    formData.append('image', blob);
		                    formData.append('type', "board");
		                    formData.append('mode', /*[[${mode}]]*/'');

		                    const response = await fetch('/tui-editor/image-upload', {
		                        method : 'POST',
		                        body : formData,
		                        headers: {
		                        	 'X-CSRF-Token':  $('#_csrf').attr('value')
		                        }, 
		                    });

		                    const json = await response.json();		                 
		                    //console.log("filename :: "+json.saveFilename);
		                    
		                    // TODO :: 업로드한 파일정보를 게시글 저장/수정 시 연결해야함.
		                    
		                    const imageUrl = `/tui-editor/image-print?filename=${json.saveFilename}`;
		                    callback(imageUrl, 'image alt attribute');

		                } catch (error) {
		                    console.error('업로드 실패 : ', error);
		                }
			      },
			    },
		});

		editor.setMarkdown(document.querySelector('#ecp1').value);

		document.querySelector('form').addEventListener('submit',
				function(event) {
					document.querySelector('#ecp1').value = '';

					const content = editor.getMarkdown();
					const encodedC = encodeURIComponent(content);

					document.querySelector('#ecp').value = encodedC;
				});
	</script>

</html>